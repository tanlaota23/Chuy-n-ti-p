#!/bin/bash
# Script tự động cài đặt và cấu hình realm với số endpoint tùy chọn

# Tải và cấp quyền thực thi
wget https://gg.amproxy.shop/realm
chmod +x realm

# Hỏi số lượng endpoint
echo "Bạn muốn cài đặt bao nhiêu endpoint (chuyển tiếp)?"
read -p "Nhập số lượng: " num_endpoints

# Kiểm tra nếu num_endpoints là số hợp lệ (cách đơn giản)
if [ "`\(num_endpoints" -eq "\)`num_endpoints" ] 2>/dev/null; then
    if [ "$num_endpoints" -le 0 ]; then
        echo "Lỗi: Vui lòng nhập một số nguyên dương lớn hơn 0!"
        exit 1
    fi
else
    echo "Lỗi: Vui lòng nhập một số nguyên dương!"
    exit 1
fi

# Tạo file realm.toml
echo "[network]" > /root/realm.toml
echo "no_tcp = false" >> /root/realm.toml
echo "use_udp = true" >> /root/realm.toml

# Lặp để hỏi IP và port cho từng endpoint
for i in $(seq 1 $num_endpoints); do
    echo "Cấu hình endpoint thứ $i:"
    read -p "Nhập IP chuyển tiếp: " ip
    read -p "Nhập port chuyển tiếp: " port
    echo "[[endpoints]]" >> /root/realm.toml
    echo "listen = \"0.0.0.0:$port\"" >> /root/realm.toml
    echo "remote = \"`\(ip:\)`port\"" >> /root/realm.toml
done

# Tạo file service
cat > /etc/systemd/system/realm.service << EOF
[Unit]
Description=realm
After=network-online.target
Wants=network-online.target systemd-networkd-wait-online.service

[Service]
Type=simple
User=root
Restart=on-failure
RestartSec=5s
DynamicUser=true
ExecStart=/root/realm -c /root/realm.toml

[Install]
WantedBy=multi-user.target
EOF

# Cấu hình và khởi động service
systemctl daemon-reload
systemctl enable realm && systemctl start realm

echo "Đã hoàn tất cài đặt và khởi động realm với $num_endpoints endpoint!"
echo "Để kiểm tra trạng thái, dùng: systemctl status realm"
